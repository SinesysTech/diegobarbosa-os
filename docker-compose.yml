# Docker Compose para Desenvolvimento Local
# 
# Para CapRover: Use o arquivo captain-definition
# Para produção completa: Os serviços MCP e Browser estão em repositórios separados
#
# Uso: docker-compose up -d

version: "3.8"

services:
  # ==========================================================================
  # SERVIÇO: Sinesys App (Next.js)
  # ==========================================================================
  sinesys_app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
        - NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY=${NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY}
    image: sinesys_app:latest
    container_name: sinesys_app
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      - PORT=3000
      - HOSTNAME=0.0.0.0
      
      # Supabase
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY=${NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY}
      - SUPABASE_SECRET_KEY=${SUPABASE_SECRET_KEY}
      
      # Browser Service (conexão externa - configure conforme seu ambiente)
      # Para desenvolvimento local sem browser remoto, deixe vazio (usa Firefox local)
      - BROWSER_WS_ENDPOINT=${BROWSER_WS_ENDPOINT:-}
      - BROWSER_SERVICE_URL=${BROWSER_SERVICE_URL:-}
      
      # Redis (opcional)
      - ENABLE_REDIS_CACHE=${ENABLE_REDIS_CACHE:-false}
      - REDIS_URL=${REDIS_URL:-}
      
      # MongoDB (opcional)
      - MONGODB_URL=${MONGODB_URL:-}
      - MONGODB_DATABASE=${MONGODB_DATABASE:-}
    networks:
      - sinesys_network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ==========================================================================
# SERVIÇOS EXTERNOS (repositórios separados)
# ==========================================================================
# 
# Os seguintes serviços agora estão em repositórios separados:
#
# 1. sinesys-mcp-server (MCP Server para agentes IA)
#    - Repositório: sinesys-mcp-server
#    - Deploy separado no CapRover: sinesys-mcp
#
# 2. sinesys-browser-server (Firefox para scraping)
#    - Repositório: sinesys-browser-server
#    - Deploy separado no CapRover: sinesys-browser
#    - WebSocket habilitado!
#
# Para desenvolvimento com todos os serviços, use docker-compose.full.yml
# ==========================================================================

networks:
  sinesys_network:
    driver: bridge

# Docker Compose para Desenvolvimento Local e Referência
# 
# Para CapRover: Use os arquivos captain-definition de cada serviço
# Para Docker Swarm com Traefik: Use docker-compose.swarm.yml
#
# Uso: docker-compose up -d

version: "3.8"

services:
  # ==========================================================================
  # SERVIÇO 1: Sinesys App (Next.js)
  # ==========================================================================
  sinesys_app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
        - NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY=${NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY}
    image: sinesys_app:latest
    container_name: sinesys_app
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      - PORT=3000
      - HOSTNAME=0.0.0.0
      
      # Supabase
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY=${NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY}
      - SUPABASE_SECRET_KEY=${SUPABASE_SECRET_KEY}
      
      # Browser Service (conexão interna)
      - BROWSER_WS_ENDPOINT=ws://sinesys_browser:3000
      - BROWSER_SERVICE_URL=http://sinesys_browser:3000
      
      # Redis (opcional)
      - ENABLE_REDIS_CACHE=${ENABLE_REDIS_CACHE:-false}
      - REDIS_URL=${REDIS_URL:-}
      
      # MongoDB (opcional)
      - MONGODB_URL=${MONGODB_URL:-}
      - MONGODB_DATABASE=${MONGODB_DATABASE:-}
    depends_on:
      - sinesys_browser
    networks:
      - sinesys_network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================================================
  # SERVIÇO 2: MCP Server (Integração com Agentes IA)
  # ==========================================================================
  sinesys_mcp:
    build:
      context: ./mcp
      dockerfile: Dockerfile
    image: sinesys_mcp:latest
    container_name: sinesys_mcp
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - SINESYS_API_URL=http://sinesys_app:3000
      - SINESYS_API_KEY=${SERVICE_API_KEY}
    depends_on:
      - sinesys_app
    networks:
      - sinesys_network

  # ==========================================================================
  # SERVIÇO 3: Browser Service (Playwright + Firefox)
  # ==========================================================================
  # Usa Firefox porque o PJE-TRT funciona melhor com ele
  sinesys_browser:
    build:
      context: .
      dockerfile: Dockerfile.browser
    image: sinesys_browser:latest
    container_name: sinesys_browser
    restart: unless-stopped
    ports:
      - "3002:3000"
    environment:
      - PORT=3000
      - BROWSER_TOKEN=${BROWSER_SERVICE_TOKEN:-}
    networks:
      - sinesys_network
    deploy:
      resources:
        limits:
          memory: 2048M
    # Necessário para rodar browser em container
    shm_size: '2gb'

networks:
  sinesys_network:
    driver: bridge


'use client';
import { useMemo, useState } from 'react';
import { useComunicaCNJStore } from '@/lib/stores/comunica-cnj-store';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { TribunalBadge } from '@/lib/components/badges';
import { ComunicacaoItem } from '@/lib/types/comunica-cnj';
import { ArrowUpDown, Download, ExternalLink, Eye, FileText } from 'lucide-react';
import { cn } from '@/lib/utils';
import { exportToExcel, exportToJSON, formatArrayForExcel, formatDateForExcel, generateFileName } from '@/lib/utils/export-helpers';
import type { ExcelColumnConfig } from '@/lib/utils/export-helpers';
import { toast } from 'sonner';
import { finalizeManualSearchExecutionAction, searchComunicacoesAction } from '@/app/actions/comunica-cnj';
import { PDFViewer } from './pdf-viewer';
const TIPO_COMUNICACAO_COLORS: Record<string, string> = { 'Intimação': 'bg-red-100 text-red-800 border-red-300', 'Lista de distribuição': 'bg-blue-100 text-blue-800 border-blue-300', 'Citação': 'bg-orange-100 text-orange-800 border-orange-300', 'Notificação': 'bg-yellow-100 text-yellow-800 border-yellow-300', 'Carta Precatória': 'bg-purple-100 text-purple-800 border-purple-300', 'Aviso': 'bg-cyan-100 text-cyan-800 border-cyan-300' };
const TIPO_DOCUMENTO_COLORS: Record<string, string> = { 'Distribuição': 'bg-purple-100 text-purple-800 border-purple-300', 'Notificação': 'bg-cyan-100 text-cyan-800 border-cyan-300', 'Acórdão': 'bg-green-100 text-green-800 border-green-300', 'Sentença': 'bg-indigo-100 text-indigo-800 border-indigo-300', 'Despacho': 'bg-gray-100 text-gray-800 border-gray-300', 'Decisão': 'bg-blue-100 text-blue-800 border-blue-300', 'Intimação': 'bg-red-100 text-red-800 border-red-300', 'Certidão': 'bg-teal-100 text-teal-800 border-teal-300' };
type SortField = 'data' | 'tribunal' | 'processo';
type SortDirection = 'asc' | 'desc';
export function ComunicaCNJResultsTable() {
  const { comunicacoes, pagination, isLoading } = useComunicaCNJStore();
  const [sortField, setSortField] = useState<SortField>('data');
  const [sortDirection, setSortDirection] = useState<SortDirection>('desc');
  const [tribunalFilter, setTribunalFilter] = useState<string>('all');
  const [tipoFilter, setTipoFilter] = useState<string>('all');
  const [categoriaFilter, setCategoriaFilter] = useState<string>('all');
  const [selectedComunicacao, setSelectedComunicacao] = useState<ComunicacaoItem | null>(null);
  const [pdfViewerOpen, setPdfViewerOpen] = useState(false);
  const [selectedPdfHash, setSelectedPdfHash] = useState<string | null>(null);
  const safeComunicacoes = Array.isArray(comunicacoes) ? comunicacoes : [];
  const uniqueTribunais = useMemo(() => { const tribunais = new Set(safeComunicacoes.map(c => c.siglaTribunal).filter(Boolean)); return Array.from(tribunais).sort(); }, [safeComunicacoes]);
  const uniqueTipos = useMemo(() => { const tipos = new Set(safeComunicacoes.map(c => c.tipoComunicacao).filter(Boolean)); return Array.from(tipos).sort(); }, [safeComunicacoes]);
  const uniqueCategorias = useMemo(() => { const categorias = new Set(safeComunicacoes.map(c => c.tipoDocumento).filter(Boolean)); return Array.from(categorias).sort(); }, [safeComunicacoes]);
  const filteredAndSortedComunicacoes = useMemo(() => { let result = [...safeComunicacoes]; if (tribunalFilter !== 'all') { result = result.filter(c => c.siglaTribunal === tribunalFilter); } if (tipoFilter !== 'all') { result = result.filter(c => c.tipoComunicacao === tipoFilter); } if (categoriaFilter !== 'all') { result = result.filter(c => c.tipoDocumento === categoriaFilter); } result.sort((a, b) => { let compareValue = 0; switch (sortField) { case 'data': const dateA = a.dataDisponibilizacao ? new Date(a.dataDisponibilizacao) : new Date(0); const dateB = b.dataDisponibilizacao ? new Date(b.dataDisponibilizacao) : new Date(0); compareValue = dateA.getTime() - dateB.getTime(); break; case 'tribunal': compareValue = (a.siglaTribunal || '').localeCompare(b.siglaTribunal || ''); break; case 'processo': compareValue = (a.numeroProcesso || '').localeCompare(b.numeroProcesso || ''); break; } return sortDirection === 'asc' ? compareValue : -compareValue; }); return result; }, [safeComunicacoes, tribunalFilter, tipoFilter, categoriaFilter, sortField, sortDirection]);
  const handleSort = (field: SortField) => { if (sortField === field) { setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc'); } else { setSortField(field); setSortDirection('desc'); } };
  const getTipoComunicacaoColor = (tipo: string) => { return TIPO_COMUNICACAO_COLORS[tipo] || 'bg-gray-100 text-gray-800 border-gray-300'; };
  const getTipoDocumentoColor = (tipo: string) => { return TIPO_DOCUMENTO_COLORS[tipo] || 'bg-gray-100 text-gray-800 border-gray-300'; };
  const fetchAllComunicacoes = async (): Promise<ComunicacaoItem[]> => { const { searchFilters, pagination } = useComunicaCNJStore.getState(); if (!searchFilters || !pagination || pagination.total === 0) { return []; } const total = Math.min(pagination.total, 10000); const pageSize = 100; const totalPages = Math.ceil(total / pageSize); const allData: ComunicacaoItem[] = []; let executionId: string | undefined; for (let page = 1; page <= totalPages; page++) { toast.info(`Buscando dados... Página ${page} de ${totalPages}`); const result = await searchComunicacoesAction({ filters: { ...searchFilters, pagina: page, itensPorPagina: pageSize }, executionId, }); if (result.success && result.data) { allData.push(...result.data.comunicacoes); if (page === 1 && result.data.executionId) { executionId = result.data.executionId; } } } if (executionId && allData.length > 0) { await finalizeManualSearchExecutionAction({ executionId, totalComunicacoesCount: allData.length }); } return allData; };
  const handleExportExcel = async (e?: React.MouseEvent) => { e?.preventDefault(); try { const allData = await fetchAllComunicacoes(); if (allData.length === 0) { toast.error('Nenhuma comunicação disponível para exportar'); return; } let filteredData = allData; if (tribunalFilter !== 'all') { filteredData = filteredData.filter(c => c.siglaTribunal === tribunalFilter); } if (tipoFilter !== 'all') { filteredData = filteredData.filter(c => c.tipoComunicacao === tipoFilter); } if (categoriaFilter !== 'all') { filteredData = filteredData.filter(c => c.tipoDocumento === categoriaFilter); } const columns: ExcelColumnConfig[] = [ { header: 'Data', key: 'dataDisponibilizacao', width: 12, formatter: formatDateForExcel }, { header: 'Tribunal', key: 'siglaTribunal', width: 10 }, { header: 'Tipo', key: 'tipoComunicacao', width: 25 }, { header: 'Categoria', key: 'tipoDocumento', width: 20 }, { header: 'Número do Processo', key: 'numeroProcesso', width: 25 }, { header: 'Partes Autoras', key: 'partesAutoras', width: 30, formatter: formatArrayForExcel }, { header: 'Partes Reus', key: 'partesReus', width: 30, formatter: formatArrayForExcel }, { header: 'Advogados', key: 'advogados', width: 30, formatter: formatArrayForExcel }, { header: 'Link', key: 'link', width: 50 }, ]; const fileName = generateFileName('comunicacoes', 'xlsx'); await exportToExcel({ data: filteredData, columns, fileName, sheetName: 'Comunicações' }); toast.success(`Exportados ${filteredData.length} comunicações para Excel`); } catch (error) { console.error('[Export Excel] Error:', error); toast.error('Erro ao exportar para Excel'); } };
  const handleExportJSON = async (e?: React.MouseEvent) => { e?.preventDefault(); try { const allData = await fetchAllComunicacoes(); if (allData.length === 0) { toast.error('Nenhuma comunicação disponível para exportar'); return; } let filteredData = allData; if (tribunalFilter !== 'all') { filteredData = filteredData.filter(c => c.siglaTribunal === tribunalFilter); } if (tipoFilter !== 'all') { filteredData = filteredData.filter(c => c.tipoComunicacao === tipoFilter); } if (categoriaFilter !== 'all') { filteredData = filteredData.filter(c => c.tipoDocumento === categoriaFilter); } const fileName = generateFileName('comunicacoes', 'json'); exportToJSON(filteredData, fileName); toast.success(`Exportados ${filteredData.length} comunicações para JSON`); } catch (error) { console.error('[Export JSON] Error:', error); toast.error('Erro ao exportar para JSON'); } };
  if (isLoading) { return <div className="p-4 text-center">Carregando...</div>; }
  if (safeComunicacoes.length === 0) { return (<div className="p-8 text-center border rounded-lg"><p className="text-muted-foreground">Nenhuma comunicação encontrada</p></div>); }
  return (
    <div className="space-y-4">
      <div className="flex flex-wrap items-end gap-4">
        <div className="flex flex-col gap-2 min-w-[200px]"><label className="text-sm font-medium">Tribunal</label><Select value={tribunalFilter} onValueChange={setTribunalFilter}><SelectTrigger><SelectValue placeholder="Todos os tribunais" /></SelectTrigger><SelectContent><SelectItem value="all">Todos os tribunais</SelectItem>{uniqueTribunais.map((tribunal) => (<SelectItem key={tribunal} value={tribunal}>{tribunal}</SelectItem>))}</SelectContent></Select></div>
        <div className="flex flex-col gap-2 min-w-[200px]"><label className="text-sm font-medium">Tipo de Comunicação</label><Select value={tipoFilter} onValueChange={setTipoFilter}><SelectTrigger><SelectValue placeholder="Todos os tipos" /></SelectTrigger><SelectContent><SelectItem value="all">Todos os tipos</SelectItem>{uniqueTipos.map((tipo) => (<SelectItem key={tipo} value={tipo}>{tipo}</SelectItem>))}</SelectContent></Select></div>
        <div className="flex flex-col gap-2 min-w-[200px]"><label className="text-sm font-medium">Categoria</label><Select value={categoriaFilter} onValueChange={setCategoriaFilter}><SelectTrigger><SelectValue placeholder="Todas as categorias" /></SelectTrigger><SelectContent><SelectItem value="all">Todas as categorias</SelectItem>{uniqueCategorias.map((categoria) => (<SelectItem key={categoria} value={categoria}>{categoria}</SelectItem>))}</SelectContent></Select></div>
        {(tribunalFilter !== 'all' || tipoFilter !== 'all' || categoriaFilter !== 'all') && (<Button variant="outline" onClick={() => { setTribunalFilter('all'); setTipoFilter('all'); setCategoriaFilter('all'); }}>Limpar Filtros</Button>)}
        <div className="flex items-center gap-0 border rounded-md overflow-hidden ml-auto"><Button variant="outline" onClick={handleExportExcel} className="rounded-none border-0 border-r"><Download className="h-4 w-4 mr-2" />Exportar Excel</Button><Button variant="outline" onClick={handleExportJSON} className="rounded-none"><Download className="h-4 w-4 mr-2" />Exportar JSON</Button></div>
      </div>
      <div className="text-sm text-muted-foreground">{filteredAndSortedComunicacoes.length} {filteredAndSortedComunicacoes.length === 1 ? 'comunicação encontrada' : 'comunicações encontradas'}</div>
      <div className="border rounded-lg"><Table><TableHeader><TableRow><TableHead className="w-[100px]"><Button variant="ghost" size="sm" className="h-8 px-2 font-semibold" onClick={() => handleSort('data')}>Data<ArrowUpDown className="ml-1 h-3 w-3" /></Button></TableHead><TableHead className="w-[120px]"><Button variant="ghost" size="sm" className="h-8 px-2 font-semibold" onClick={() => handleSort('tribunal')}>Tribunal<ArrowUpDown className="ml-1 h-3 w-3" /></Button></TableHead><TableHead className="w-[180px]"><Button variant="ghost" size="sm" className="h-8 px-2 font-semibold" onClick={() => handleSort('processo')}>Processo<ArrowUpDown className="ml-1 h-3 w-3" /></Button></TableHead><TableHead className="w-[180px]">Tipo</TableHead><TableHead className="w-[150px]">Categoria</TableHead><TableHead className="w-[200px]">Autor(es)</TableHead><TableHead className="w-[200px]">Réu(s)</TableHead><TableHead className="w-[120px] text-center">Ações</TableHead></TableRow></TableHeader><TableBody>{filteredAndSortedComunicacoes.length === 0 ? (<TableRow><TableCell colSpan={8} className="text-center py-8 text-muted-foreground">Nenhuma comunicação encontrada com os filtros selecionados</TableCell></TableRow>) : (filteredAndSortedComunicacoes.map((comunicacao) => (<TableRow key={comunicacao.hash}><TableCell className="text-xs">{comunicacao.dataDisponibilizacaoFormatada || '-'}</TableCell><TableCell><TribunalBadge codigo={comunicacao.siglaTribunal} className="text-xs" /></TableCell><TableCell className="font-mono text-xs"><div className="flex flex-col gap-0.5"><span className="font-medium">{comunicacao.numeroProcessoComMascara}</span><span className="text-muted-foreground text-[10px]">{comunicacao.nomeClasse}</span></div></TableCell><TableCell><Badge className={cn('text-xs border', getTipoComunicacaoColor(comunicacao.tipoComunicacao))}>{comunicacao.tipoComunicacao}</Badge></TableCell><TableCell><Badge className={cn('text-xs border', getTipoDocumentoColor(comunicacao.tipoDocumento))}>{comunicacao.tipoDocumento}</Badge></TableCell><TableCell className="text-xs">{comunicacao.partesAutoras && comunicacao.partesAutoras.length > 0 ? (<div className="line-clamp-2" title={comunicacao.partesAutoras.join(', ')}>{comunicacao.partesAutoras.join(', ')}</div>) : (<span className="text-muted-foreground">-</span>)}</TableCell><TableCell className="text-xs">{comunicacao.partesReus && comunicacao.partesReus.length > 0 ? (<div className="line-clamp-2" title={comunicacao.partesReus.join(', ')}>{comunicacao.partesReus.join(', ')}</div>) : (<span className="text-muted-foreground">-</span>)}</TableCell><TableCell><div className="flex items-center justify-center gap-1"><Button variant="ghost" size="icon" className="h-8 w-8" onClick={() => setSelectedComunicacao(comunicacao)} title="Ver detalhes"><Eye className="h-4 w-4" /></Button><Button variant="ghost" size="icon" className="h-8 w-8" onClick={() => { setSelectedPdfHash(comunicacao.hash); setPdfViewerOpen(true); }} title="Ver certidão" aria-label="Ver certidão"><FileText className="h-4 w-4" /></Button><Button variant="ghost" size="icon" className="h-8 w-8" asChild title="Ver no PJE"><a href={comunicacao.link} target="_blank" rel="noopener noreferrer" aria-label="Ver no PJE"><ExternalLink className="h-4 w-4" /></a></Button></div></TableCell></TableRow>)))}</TableBody></Table></div>
      {pagination && (<div className="text-sm text-muted-foreground text-center">Página {pagination.pagina} de {pagination.totalPaginas} - Total: {pagination.total}</div>)}
      <Dialog open={!!selectedComunicacao} onOpenChange={() => setSelectedComunicacao(null)}><DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto"><DialogHeader><DialogTitle>Detalhes da Comunicação</DialogTitle><DialogDescription>Informações completas sobre a comunicação processual</DialogDescription></DialogHeader>{selectedComunicacao && (<div className="space-y-6"><div><h3 className="font-semibold mb-3 text-sm">Processo</h3><div className="grid grid-cols-2 gap-3 text-sm"><div><span className="text-muted-foreground">Número:</span><p className="font-mono font-medium">{selectedComunicacao.numeroProcessoComMascara}</p></div><div><span className="text-muted-foreground">Tribunal:</span><p className="font-medium">{selectedComunicacao.siglaTribunal}</p></div><div><span className="text-muted-foreground">Classe:</span><p>{selectedComunicacao.nomeClasse}</p></div><div><span className="text-muted-foreground">Órgão:</span><p>{selectedComunicacao.nomeOrgao}</p></div></div></div><div><h3 className="font-semibold mb-3 text-sm">Comunicação</h3><div className="grid grid-cols-2 gap-3 text-sm"><div><span className="text-muted-foreground">Tipo:</span><div className="mt-1"><Badge className={cn('text-xs border', getTipoComunicacaoColor(selectedComunicacao.tipoComunicacao))}>{selectedComunicacao.tipoComunicacao}</Badge></div></div><div><span className="text-muted-foreground">Categoria:</span><div className="mt-1"><Badge className={cn('text-xs border', getTipoDocumentoColor(selectedComunicacao.tipoDocumento))}>{selectedComunicacao.tipoDocumento}</Badge></div></div><div><span className="text-muted-foreground">Data:</span><p>{selectedComunicacao.dataDisponibilizacaoFormatada || '-'}</p></div></div></div><div><h3 className="font-semibold mb-3 text-sm">Partes</h3><div className="space-y-3 text-sm">{selectedComunicacao.partesAutoras && selectedComunicacao.partesAutoras.length > 0 && (<div><span className="text-muted-foreground">Autor(es):</span><ul className="mt-1 ml-4 list-disc">{selectedComunicacao.partesAutoras.map((autor, idx) => (<li key={idx}>{autor}</li>))}</ul></div>)}{selectedComunicacao.partesReus && selectedComunicacao.partesReus.length > 0 && (<div><span className="text-muted-foreground">Réu(s):</span><ul className="mt-1 ml-4 list-disc">{selectedComunicacao.partesReus.map((reu, idx) => (<li key={idx}>{reu}</li>))}</ul></div>)}</div></div>{selectedComunicacao.advogados && selectedComunicacao.advogados.length > 0 && (<div><h3 className="font-semibold mb-3 text-sm">Advogados</h3><ul className="ml-4 list-disc text-sm">{selectedComunicacao.advogados.map((advogado, idx) => (<li key={idx}>{advogado}</li>))}</ul></div>)}{selectedComunicacao.texto && (<div><h3 className="font-semibold mb-3 text-sm">Conteúdo</h3><div className="text-sm p-3 bg-muted/50 rounded-md border prose prose-sm max-w-none" dangerouslySetInnerHTML={{ __html: selectedComunicacao.texto }} /></div>)}<div className="flex gap-2 pt-4 border-t"><Button variant="outline" size="sm" onClick={() => { setSelectedPdfHash(selectedComunicacao.hash); setPdfViewerOpen(true); }}><FileText className="h-4 w-4 mr-2" />Ver Certidão</Button><Button variant="outline" size="sm" asChild><a href={selectedComunicacao.link} target="_blank" rel="noopener noreferrer"><ExternalLink className="h-4 w-4 mr-2" />Ver no PJE</a></Button></div></div>)}</DialogContent></Dialog>
      {selectedPdfHash && (<PDFViewer hash={selectedPdfHash} open={pdfViewerOpen} onOpenChange={(open) => { setPdfViewerOpen(open); if (!open) { setSelectedPdfHash(null); } }} title="Certidão da Comunicação" />)}
    </div>
  );
}


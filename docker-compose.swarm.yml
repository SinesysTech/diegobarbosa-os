version: "3.7"

# ============================================================================
# SINESYS - Stack de Serviços
# ============================================================================
# 
# Arquitetura de 3 serviços:
# 1. sinesys_app      - Frontend Next.js (API + UI)
# 2. sinesys_mcp      - MCP Server (integração com agentes IA)
# 3. sinesys_browser  - Browser Service (Browserless para scraping)
#
# Comunicação interna via rede Docker (network_swarm_public)
# ============================================================================

services:
  # ==========================================================================
  # SERVIÇO 1: Sinesys App (Next.js)
  # ==========================================================================
  sinesys_app:
    image: sinesys_app:latest
    hostname: "{{.Service.Name}}.{{.Task.Slot}}"
    networks:
      - network_swarm_public
    environment:
      # Supabase
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY=${NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY}
      - SUPABASE_SECRET_KEY=${SUPABASE_SECRET_KEY}
      
      # Next.js
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      - PORT=3000
      - HOSTNAME=0.0.0.0
      
      # Browser Service (conexão interna)
      - BROWSER_WS_ENDPOINT=ws://sinesys_browser:3000
      - BROWSER_SERVICE_URL=http://sinesys_browser:3000
      
      # Redis (opcional)
      - ENABLE_REDIS_CACHE=${ENABLE_REDIS_CACHE:-false}
      - REDIS_URL=${REDIS_URL:-}
      
      # MongoDB (opcional)
      - MONGODB_URL=${MONGODB_URL:-}
      - MONGODB_DATABASE=${MONGODB_DATABASE:-}

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      
      resources:
        limits:
          cpus: "1.5"
          memory: 1024M
        reservations:
          cpus: "0.5"
          memory: 512M
      
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 3
        window: 120s

      labels:
        # Traefik - Router principal HTTPS
        - traefik.enable=true
        - traefik.http.routers.sinesys_app.rule=Host(`${DOMAIN}`)
        - traefik.http.routers.sinesys_app.entrypoints=websecure
        - traefik.http.routers.sinesys_app.tls.certresolver=letsencryptresolver
        - traefik.http.routers.sinesys_app.tls=true
        - traefik.http.routers.sinesys_app.service=sinesys_app
        
        # Traefik - Redirecionamento HTTP para HTTPS
        - traefik.http.routers.sinesys_app-http.rule=Host(`${DOMAIN}`)
        - traefik.http.routers.sinesys_app-http.entrypoints=web
        - traefik.http.routers.sinesys_app-http.middlewares=redirect-to-https
        
        # Middleware de redirecionamento
        - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https
        - traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true
        
        # Service
        - traefik.http.services.sinesys_app.loadbalancer.server.port=3000
        - traefik.http.services.sinesys_app.loadbalancer.passHostHeader=true
        - traefik.docker.network=network_swarm_public
      
      update_config:
        parallelism: 1
        delay: 30s
        order: start-first
        failure_action: rollback

  # ==========================================================================
  # SERVIÇO 2: MCP Server (Integração com Agentes IA)
  # ==========================================================================
  sinesys_mcp:
    image: sinesys_mcp:latest
    hostname: "{{.Service.Name}}.{{.Task.Slot}}"
    networks:
      - network_swarm_public
    environment:
      - NODE_ENV=production
      - PORT=3001
      
      # URL da API do Sinesys (comunicação interna)
      - SINESYS_API_URL=http://sinesys_app:3000
      - SINESYS_API_KEY=${SERVICE_API_KEY}

    healthcheck:
      test: ["CMD", "node", "-e", "console.log('ok')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 128M
      
      restart_policy:
        condition: on-failure
        delay: 15s
        max_attempts: 3
        window: 60s

      labels:
        # Traefik - Expor MCP via subdomínio (opcional)
        - traefik.enable=true
        - traefik.http.routers.sinesys_mcp.rule=Host(`mcp.${DOMAIN}`)
        - traefik.http.routers.sinesys_mcp.entrypoints=websecure
        - traefik.http.routers.sinesys_mcp.tls.certresolver=letsencryptresolver
        - traefik.http.routers.sinesys_mcp.tls=true
        - traefik.http.services.sinesys_mcp.loadbalancer.server.port=3001
        - traefik.docker.network=network_swarm_public
      
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback

  # ==========================================================================
  # SERVIÇO 3: Browser Service (Playwright + Firefox)
  # ==========================================================================
  # 
  # Usando Firefox via Playwright Browser Server
  # O PJE-TRT funciona melhor com Firefox (menos detecção/bloqueio)
  # 
  # Build: docker build -f Dockerfile.browser -t sinesys_browser:latest .
  # ==========================================================================
  sinesys_browser:
    image: sinesys_browser:latest
    hostname: "{{.Service.Name}}.{{.Task.Slot}}"
    networks:
      - network_swarm_public
    environment:
      - PORT=3000
      - BROWSER_TOKEN=${BROWSER_SERVICE_TOKEN:-}

    healthcheck:
      test: ["CMD", "node", "/app/healthcheck.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      
      resources:
        limits:
          cpus: "2"
          memory: 2048M
        reservations:
          cpus: "0.5"
          memory: 1024M
      
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 3
        window: 120s

      labels:
        # Não expor externamente (apenas acesso interno)
        - traefik.enable=false
      
      update_config:
        parallelism: 1
        delay: 30s
        order: stop-first
        failure_action: rollback

networks:
  network_swarm_public:
    name: network_swarm_public
    external: true
